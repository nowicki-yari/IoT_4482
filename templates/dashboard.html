<!DOCTYPE html>
<!-- Template by Quackit.com -->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<!-- CHARTS MIS JS scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha256-R4pqcOYV8lt7snxMQO/HSbVCFRPMdrhAFMH+vr9giYI=" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    var realTimeData;
	var realTimeDataMoist;
    window.addEventListener('load', function() {
        const ctx = document.getElementById('temperature_chart').getContext('2d');
        realTimeData = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Temperature',
                data: []
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                }],
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
        }
    });
    })
    function addData(chart, label, data) {
		if(format) {
			chart.data.labels.push(label);
			chart.data.datasets.forEach((dataset) => {
				dataset.data.push(data);
			});
			chart.update();
		}
		else {
			chart.data.labels.push(label);
			chart.data.datasets.forEach((dataset) => {
				dataset.data.push(data * 1.8 + 32.0);
			});
			chart.update();
		}
    }

	 window.addEventListener('load', function() {
		const ctx = document.getElementById('moist_chart').getContext('2d');
		const canvas = document.getElementById('moist_chart');
		canvas.style.display = "none"
		realTimeDataMoist = new Chart(ctx, {
		type: 'line',
		data: {
			datasets: [{
				label: 'Moist',
				data: []
			}]
		},
		options: {
			scales: {
				xAxes: [{
					ticks: {
						autoSkip: true,
						maxTicksLimit: 10
					}
				}],
				yAxes: [{
					ticks: {
						beginAtZero: true
					}
				}]
			},
		}
		});
	})

	 $(document).ready(function() {
		//var socket = io.connect('http://' + document.domain + ':' + location.port, {secure: true});

		socket.on('mqtt_message', function(data) {
			const d = new Date();
			let time = d.toLocaleTimeString();
			if (data['topic']=='ledstatus') {
				addData(realTimeData, time, data['payload']);
				console.log("ledstatus");
			} else if (data['topic']=='moist') {
				console.log("moist")
				addMoistData(realTimeDataMoist, time, data['payload']);
			}
		})
	});

</script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    var historicalData;
    window.addEventListener('load', function() {
        const ctx = document.getElementById('temperature_history_chart').getContext('2d');
        historicalData = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Temperature',
                data: []
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                }],
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
        }
    });
    })

    $(document).ready(function() {
        socket.on('historical_data', function(data) {
				addData(historicalData, data['time'], data['value']);
        })
    });

    $(document).ready(function() {
        socket.on('historical_data_cal', function(data) {
				arr = data['value'];
				if (arr.length == 0){
					window.alert("No temperature data for this day!");
				}
				else {
					var conainerTemp = document.getElementById("temperature_history_chart");
					console.log();
					if (conainerTemp.lastChild.nodeName === "CANVAS") {
						conainerTemp.lastChild.remove();
					}
					for(let i = 0; i<arr.length; i++){
						addData(historicalData, data['time'][i], data['value'][i]);
					}
				}
		})
    });

    $(document).ready(function() {
        //var socket = io.connect('http://' + document.domain + ':' + location.port, {secure: true});
        socket.on('moist_Historical_Data_cal', function(data) {
				arr = data['value'];
				if (arr.length == 0){
					window.alert("No moist data for this day!");
				}
				else {
					for(let i = 0; i < arr.length; i++){
						addMoistData(moistHistoricalData, data['time'][i], data['value'][i]);
					}
				}
		})
    });
    var socket = io();
    var moistHistoricalData;
    window.addEventListener('load', function() {
        const ctx = document.getElementById('moist_history_chart').getContext('2d');
        moistHistoricalData = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Moist',
                data: []
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                }],
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
        }
    });
    })

    $(document).ready(function() {
        //var socket = io.connect('http://' + document.domain + ':' + location.port, {secure: true});
        socket.on('moist_Historical_Data', function(data) {
				addMoistData(moistHistoricalData, data['time'], data['value']);
        })
    });

	var format = 1;

    function addMoistData(chart, label, data) {
		chart.data.labels.push(label);
		chart.data.datasets.forEach((dataset) => {
			dataset.data.push(data);
		});
		chart.update();
	}

	function isObjectEmpty(obj) {
		return Object.keys(obj).length === 0;
	}

    function publish(message) {
        var data = '{"topic": "pwm", "message": "' + message + '", "qos": 1}';
        socket.emit('publish', data=data);
    }
	
	function changeToCelcius(){
		format = 1;
	}

	function changeToFarenheit(){
		format = 0;
	}

	function publish(message) {
			const canvas = document.getElementById('moist_chart')
			if (message == 'ON') {
				canvas.style.display = "block"
			} else if (message == 'OFF') {
				canvas.style.display = "none"
			}
			var data = '{"topic": "pwm", "message": "' + message + '", "qos": 1}';
			socket.emit('publish', data=data);
		}

</script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type=text/javascript>
        $(function() {
          $('a#day_today').on('click', function(e) {
            e.preventDefault()
            $.getJSON('/data_today',
                function(data) {
              //do nothing
            });
            return false;
          });
        });

        $(function() {
          $('a#day_yesterday').on('click', function(e) {
            e.preventDefault()
            $.getJSON('/data_yesterday',
                function(data) {
              //do nothing
            });
            return false;
          });
        });

         $(function() {
          $('a#enable_sensor').on('click', function(e) {
            e.preventDefault()
            return false;
          });
        });

         $(function() {
          $('a#disable_sensor').on('click', function(e) {
            e.preventDefault()
            return false;
          });
        });
</script>
  
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>IoT Weather Station</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/css/bootstrap.min.css" integrity="sha384-MIwDKRSSImVFAZCVLtU0LMDdON6KVCrZHyVQQj6e8wIEJkW4tvwqXrbMIya1vriY" crossorigin="anonymous">
      
    <!-- Some extra styles (remove if not needed) -->
    <style>
        section {
            padding: 70px 0;
            border-bottom: 1px dotted #ccc;
        }

        /* So that we can see the grid */
        .grid-example  div[class^="col"] {
            border: 1px solid white;
            background: lightblue;
            text-align: center;
            padding-top: 8px;
            padding-bottom: 8px;
            }
        /* Overide Jumbotron's color */
        .jumbotron {
    background-color: lightskyblue;
        }
    </style>
  </head>

  <body data-spy="scroll" data-target="#navbar-example">

    <nav id="topNav" class="navbar navbar-full navbar-static-top navbar-dark bg-inverse">
        <div class="container">
            <button class="navbar-toggler hidden-md-up pull-right" type="button" data-toggle="collapse" data-target="#collapsingNavbar">
                &#9776;
            </button>
            <a class="navbar-brand" href="#">Home</a>
            <div class="collapse navbar-toggleable-sm" id="collapsingNavbar">
                <ul class="nav navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#soilData">Soil Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#temperatureData">Temperature Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#history">History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#measurementSettings">Measurement Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="jumbotron jumbotron-fluid">
      <div class="container">
        <h1 class="display-3">Welcome to the Weatherstation</h1>
        <p>This weather station monitors the soil moisture at different depths in the subsoil as well as the outdoor temperature. The depth is adjustable via this dashboard. The dashboard also displays the measurement results in real time and from the past days.</p>
        <p>Application created by Yari Nowicki & Siemen Vandervoort!</p>
        <p><a class="btn btn-primary btn-lg" href="https://www.buienradar.be/" role="button">Weather radar &raquo;</a></p>
      </div>
    </div>

    <div class="container">
		<section id="soilData">
			<h2> Soil Data </h2>
            <p> This graph shows the real time soil data as a function of time.</p>
            <form style="float: left; margin: 2px">
                <a href=# id=enable_sensor><button class='btn btn-default' onclick="publish('ON')">Enable</button></a>
            </form>
            <form style="float: left; margin: 2px">
                <a href=# id=disable_sensor><button class='btn btn-default' onclick="publish('OFF')">Disable</button></a>
            </form>
			<canvas id="moist_chart"></canvas>
		</section>
		<section id="temperatureData">
			<h2> Temperature Data </h2>
            <p> This graph shows the real time temperature data as a function of time.</p>
            <canvas id="temperature_chart"></canvas>
		</section>
		<section id="history">
			<h2> Data History </h2>
			<p> Here you can find the previous measurements. Use the buttons or pick a date and import the data. </p>
            <form style="float: left; margin: 2px">
                <a href=# id=day_today><button class='btn btn-default'>Today</button></a>
            </form>
            <form style="float: left; margin: 2px">
                <a href=# id=day_yesterday><button class='btn btn-default'>Yesterday</button></a>
            </form>
			<form action="{{ url_for('calendarInput') }}" method="post" style="float: left; margin: 2px">
				<input type="date" id="calendar" name="date" value="2000-01-01" min="2018-01-01" max="2025-12-31" class='btn btn-default'>
				<input type="submit" value="Import data" class='btn btn-default'>
			</form>
			<canvas id="temperature_history_chart"></canvas>
			<canvas id="moist_history_chart"></canvas>
		</section>
		<section id="measurementSettings">
			<h2> Measurement Settings </h2>
            <p> Choose temperature format:</p>
				<div class="custom-controls-stacked">
					<label class="custom-control custom-radio">
						<input checked value="1" id="bulletCelcius" onclick="changeToCelcius()" name="radio-stacked" type="radio" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Celcius</span>
					</label>
					<label class="custom-control custom-radio">
						<input value="0" id="bulletFarenheit" onclick="changeToFarenheit()" name="radio-stacked" type="radio" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Farenheit</span>
					</label>
				</div>
		</section>
		<section id="about">
			<h2> About The Authors </h2>
            <p> This assignment was made for the Internet of Things course that is part of the master year for Electronics and ICT engineering technology. </p>
		</section>
    </div> <!-- /container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js" integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY" crossorigin="anonymous"></script>

    <!-- Tether -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js" integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB" crossorigin="anonymous"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/js/bootstrap.min.js" integrity="sha384-ux8v3A6CPtOTqOzMKiuo3d/DomGaaClxFYdCu2HPMBEkf6x2xiDyJ7gkXU0MWwaD" crossorigin="anonymous"></script>

    <!-- Initialize Bootstrap functionality -->
    <script>
    // Initialize tooltip component
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })

    // Initialize popover component
    $(function () {
      $('[data-toggle="popover"]').popover()
    })
    </script>    

  </body>
</html>